# "one_time_secrets"

Проект представляет собой HTTP-сервис на базе FastAPI, предназначенный для безопасного хранения и управления «секретами». Основная цель сервиса — обеспечение одноразового доступа к секретам: после первого запроса по уникальному ключу секрет становится недоступным.

---

### Основные особенности проекта:

1. **Одноразовый доступ к секретам**:
   - Секреты выдаются только один раз. После первого запроса по уникальному ключу они автоматически удаляются из системы.

2. **Кеширование**:
   - Для повышения производительности созданные секреты хранятся в серверном кеше (Redis) 5 минут с момента создания.

3. **Шифрование данных**:
   - Все секреты хранятся в зашифрованном виде как в базе данных, так и в кеше.

4. **Запрет клиентского кеширования**:
   - Сервис выставляет специальные HTTP-заголовки, запрещающие кеширование данных на стороне клиента и промежуточных прокси.

5. **Логирование действий**:
   - Вся активность пользователей (например, создание, чтение, удаление секретов) фиксируется в базе данных PostgreSQL. Логи включают метаданные, такие как IP-адреса, временные метки и действия, что позволяет отслеживать историю работы с сервисом.

6. **Использование PostgreSQL**:
   - База данных PostgreSQL используется для долговременного хранения логов и метаданных.

7. **Периодическая очистка просроченных секретов (с учётом кеша)**:
   - С помощью функции `clean_expired_secrets` настроено удаление всех секретов с истёкшим сроком (ttl_seconds)

---

### Технологический стек:
- **Web-фреймворк**: FastAPI.
- **База данных**: PostgreSQL.
- **Кеширование**: Redis.
- **Контейнеризация**: Docker (Dockerfile / docker-compose).

---

### Настройка перед запуском:

Перед запуском проекта необходимо выполнить несколько шагов для его корректной настройки.

---


#### 1. **Создание и активация виртуального окружения**

Если оно ещё не создано/активировано:

```bash
# Создание виртуального окружения
python -m venv .venv

# Активация виртуального окружения для Windows:
.venv\Scripts\activate
```

#### 2. **Установка зависимостей**

```bash
pip install -r requirements.txt
```

#### 3. **Создание файла .env в корне проекта (на уровне Dockerfile)**

```ini
# -----------------------------------------------------------------------------
# URL базы данных для Docker и для применения миграций до запуска контейнера
# -----------------------------------------------------------------------------
DOCKER_POSTGRES_URL=postgresql+psycopg2://username:password@host.docker.internal:5432/dbname
NO_DOCKER_POSTGRES_URL=postgresql+psycopg2://username:password@localhost:5432/dbname

# -----------------------------------------------------------------------------
# Секретный ключ для шифрования данных
# -----------------------------------------------------------------------------
ENCRYPTION_KEY=your-encryption-key-here

# -----------------------------------------------------------------------------
# Флаг для использования Docker (1/0)
# -----------------------------------------------------------------------------
USE_DOCKER=1
```

#### 4. **Создание и применение миграций в базу данных**

- Установка `USE_DOCKER=0` в `.env`
- Затем:
```bash
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

- Последующая установка `USE_DOCKER=1` в `.env`

#### 5. **Запуск проекта**

```bash
docker-compose up --build

```
После успешного запуска весь функционал сервиса станет доступен через Swagger UI. Для тестирования эндпоинтов можно перейти по ссылке:

[Swagger UI](http://localhost:8000/docs)

---

### Обзор основного функционала:

#### 1. **Создание секрета**

![Снимок экрана 2025-04-05 165931](https://github.com/user-attachments/assets/d6638fb6-e5d3-4a7c-84da-9b73815d377b)


![Снимок экрана 2025-04-05 165941](https://github.com/user-attachments/assets/d0881a6e-017c-4ef5-932f-cce8e431d273)



#### 2. **Получение секрета**

- **попытка запроса с неверной кодовой фразой**


![Снимок экрана 2025-04-05 170001](https://github.com/user-attachments/assets/3131d654-8c7a-4da2-8f74-0c954cf0b3c2)

- **запрос с валидными данными**

![Снимок экрана 2025-04-05 170018](https://github.com/user-attachments/assets/5c299b5c-4f43-48af-9ee8-14c5a9d81427)

- **повторный запрос**


![Снимок экрана 2025-04-05 170028](https://github.com/user-attachments/assets/d6623808-cb2a-4144-bd59-17b65a0577d1)



#### 3. **Удаление секрета**


![Снимок экрана 2025-04-05 170047](https://github.com/user-attachments/assets/3d977ef2-679d-4de2-8d3c-c036b6f2595d)

