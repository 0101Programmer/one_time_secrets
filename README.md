# "one_time_secrets"

Проект представляет собой HTTP-сервис на базе FastAPI, предназначенный для безопасного хранения и управления «секретами». Основная цель сервиса — обеспечение одноразового доступа к секретам: после первого запроса по уникальному ключу секрет становится недоступным.

---

### Основные особенности проекта:

1. **Одноразовый доступ к секретам**:
   - Секреты выдаются только один раз. После первого запроса по уникальному ключу они автоматически удаляются из системы.

2. **Кеширование**:
   - Для повышения производительности созданные секреты хранятся в серверном кеше (Redis) 5 минут с момента создания.

3. **Шифрование данных**:
   - Все секреты хранятся в зашифрованном виде как в базе данных, так и в кеше.

4. **Запрет клиентского кеширования**:
   - Сервис выставляет специальные HTTP-заголовки, запрещающие кеширование данных на стороне клиента и промежуточных прокси.

5. **Логирование действий**:
   - Вся активность пользователей (например, создание, чтение, удаление секретов) фиксируется в базе данных PostgreSQL. Логи включают метаданные, такие как IP-адреса, временные метки и действия, что позволяет отслеживать историю работы с сервисом.

6. **Использование PostgreSQL**:
   - База данных PostgreSQL используется для долговременного хранения логов и метаданных.

7. **Периодическая очистка просроченных секретов (с учётом кеша)**:
   - С помощью функции `clean_expired_secrets` настроено удаление всех секретов с истёкшим сроком (ttl_seconds)

---

### Технологический стек:
- **Web-фреймворк**: FastAPI.
- **База данных**: PostgreSQL.
- **Кеширование**: Redis.
- **Контейнеризация**: Docker (Dockerfile / docker-compose).

---

### Настройка перед запуском:

Перед запуском проекта необходимо выполнить несколько шагов для его корректной настройки.

---


#### 1. **Создание и активация виртуального окружения**

Если оно ещё не создано/активировано:

```bash
# Создание виртуального окружения
python -m venv .venv

# Активация виртуального окружения для Windows:
.venv\Scripts\activate
```

#### 2. **Установка зависимостей**

```bash
pip install -r requirements.txt
```

#### 3. **Создание файла .env в корне проекта (на уровне Dockerfile)**

```ini
# -----------------------------------------------------------------------------
# URL базы данных для Docker и для применения миграций до запуска контейнера
# -----------------------------------------------------------------------------
DOCKER_POSTGRES_URL=postgresql+psycopg2://username:password@host.docker.internal:5432/dbname
NO_DOCKER_POSTGRES_URL=postgresql+psycopg2://username:password@localhost:5432/dbname

# -----------------------------------------------------------------------------
# Секретный ключ для шифрования данных
# -----------------------------------------------------------------------------
ENCRYPTION_KEY=your-encryption-key-here

# -----------------------------------------------------------------------------
# Флаг для использования Docker (1/0)
# -----------------------------------------------------------------------------
USE_DOCKER=1
```

#### 4. **Создание и применение миграций в базу данных**

- Установка `USE_DOCKER=0` в `.env`
- Затем:
```bash
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

- Последующая установка `USE_DOCKER=1` в `.env`

#### 5. **Запуск проекта**

```bash
docker-compose up --build

```
После успешного запуска весь функционал сервиса станет доступен через Swagger UI. Для тестирования эндпоинтов можно перейти по ссылке:

[Swagger UI](http://localhost:8000/docs)

---

### Обзор основного функционала:

#### 1. **Создание секрета**
#### 2. **Получение секрета**
#### 3. **Удаление секрета**

